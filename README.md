Version:0.9
StartHTML:0000000155
EndHTML:0000122570
StartFragment:0000000191
EndFragment:0000122534
SourceURL:https://zhuanlan.zhihu.com/p/632134425
<html>
<body>
<!--StartFragment--><div class="Post-RichTextContainer" style="position: relative; margin: 0px auto; overflow: visible; width: 690px; color: rgb(18, 18, 18); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: medium; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"><div class="css-1yuhvjn" style="margin-top: 16px;"><div class="css-376mun" style="position: relative; display: inline;"><div class="RichText ztext Post-RichText css-1g0fqss" options="[object Object]" style="line-height: 1.6; word-break: break-word;"><p data-first-child="" data-pid="uNafYnmy" style="margin: 0px 0px 1.4em;">大气散射效果对游戏画质提升来说巨大，本文主要从代码层面讲解下大气散射</p><p class="ztext-empty-paragraph" style="margin: -0.8em 0px;"><br></p><h2 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.2em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(2.33333em) 0px calc(1.16667em); clear: left; font-synthesis: style;">单次散射</h2><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic1.zhimg.com/80/v2-d3a196848ac38ed78d769a23afe6d2e8_720w.webp" data-rawwidth="1112" data-rawheight="524" data-size="normal" class="origin_image zh-lightbox-thumb lazy" width="1112" data-original="https://pic1.zhimg.com/v2-d3a196848ac38ed78d769a23afe6d2e8_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-d3a196848ac38ed78d769a23afe6d2e8_b.jpg" data-original-token="v2-9bcabe275d66d51134fd225c4453d92c" height="524" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div><figcaption style="color: rgb(153, 153, 153); font-size: 0.9em; line-height: 1.5; margin-top: calc(0.666667em); padding: 0px 1em; text-align: center;">路径 AB 观察大气，并且求解 B 点的大气颜色，光线在大气中只发生一次散射，散射点为 P</figcaption></figure><p data-pid="bfVWkMVY" style="margin: 1.4em 0px;">阳光进入大气层CP开始衰减，在P点发生散射，然后PA衰减进入A点相机</p><p data-pid="myUOtc2s" style="margin: 1.4em 0px;"><span class="ztext-math" data-eeimg="1" data-tex="I_{CP}=\boxed{I_P}{S(\lambda,\theta,h)} {T(CP)}"><span></span><span><span class="MathJax_Preview" style="color: inherit; display: contents;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>I</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>C</mi><mi>P</mi></mrow></msub><mo>=</mo><menclose notation=&quot;box&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mstyle displaystyle=&quot;true&quot; scriptlevel=&quot;0&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>I</mi><mi>P</mi></msub></mrow></mstyle></mrow></menclose><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>S</mi><mo stretchy=&quot;false&quot;>(</mo><mi>&amp;#x03BB;</mi><mo>,</mo><mi>&amp;#x03B8;</mi><mo>,</mo><mi>h</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>T</mi><mo stretchy=&quot;false&quot;>(</mo><mi>C</mi><mi>P</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></math>" role="presentation" style="display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size: 16px; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="27.368ex" height="3.6ex" viewBox="0 -1049.3 11783.2 1550" role="img" focusable="false" aria-hidden="true" style="vertical-align: -1.163ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#MJMATHI-49" x="0" y="0"></use><g transform="translate(440,-155)"><use transform="scale(0.707)" xlink:href="#MJMATHI-43" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMATHI-50" x="760" y="0"></use></g><use xlink:href="#MJMAIN-3D" x="1887" y="0"></use><g transform="translate(3221,0)"><g transform="translate(275,0)"><use xlink:href="#MJMATHI-49" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMATHI-50" x="622" y="-213"></use></g><line stroke-linecap="square" stroke-width="75" y2="37" y1="37" x1="37" x2="1584" transform="translate(0,884)"></line><line stroke-linecap="square" stroke-width="75" y1="37" x2="37" x1="37" y2="1347" transform="translate(1546,-426)"></line><line stroke-linecap="square" stroke-width="75" y2="37" y1="37" x1="37" x2="1584" transform="translate(0,-426)"></line><line stroke-linecap="square" stroke-width="75" y1="37" x2="37" x1="37" y2="1347" transform="translate(0,-426)"></line></g><g transform="translate(4843,0)"><use xlink:href="#MJMATHI-53" x="0" y="0"></use><use xlink:href="#MJMAIN-28" x="645" y="0"></use><use xlink:href="#MJMATHI-3BB" x="1035" y="0"></use><use xlink:href="#MJMAIN-2C" x="1618" y="0"></use><use xlink:href="#MJMATHI-3B8" x="2063" y="0"></use><use xlink:href="#MJMAIN-2C" x="2533" y="0"></use><use xlink:href="#MJMATHI-68" x="2978" y="0"></use><use xlink:href="#MJMAIN-29" x="3554" y="0"></use></g><g transform="translate(8787,0)"><use xlink:href="#MJMATHI-54" x="0" y="0"></use><use xlink:href="#MJMAIN-28" x="704" y="0"></use><use xlink:href="#MJMATHI-43" x="1094" y="0"></use><use xlink:href="#MJMATHI-50" x="1854" y="0"></use><use xlink:href="#MJMAIN-29" x="2606" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation" style="top: 0px; left: 0px; clip: rect(1px, 1px, 1px, 1px); user-select: none; position: absolute !important; padding: 1px 0px 0px !important; border: 0px !important; height: 1px !important; width: 1px !important; overflow: hidden !important; display: block !important; transition: none 0s ease 0s;"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>�</mi><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mi>�</mi></mrow></msub><mo>=</mo><menclose notation="box"><mrow class="MJX-TeXAtom-ORD"><mstyle displaystyle="true" scriptlevel="0"><mrow class="MJX-TeXAtom-ORD"><msub><mi>�</mi><mi>�</mi></msub></mrow></mstyle></mrow></menclose><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>�</mi><mo>,</mo><mi>�</mi><mo>,</mo><mi>ℎ</mi><mo stretchy="false">)</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>�</mi><mi>�</mi><mo stretchy="false">)</mo></mrow></math></span></span></span></span></p><p data-pid="oIVEP58V" style="margin: 1.4em 0px;"><span class="ztext-math" data-eeimg="1" data-tex="I_{PA}=\boxed{I_P}{S(\lambda,\theta,h)} {T(PA)}"><span></span><span><span class="MathJax_Preview" style="color: inherit; display: contents;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>I</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>P</mi><mi>A</mi></mrow></msub><mo>=</mo><menclose notation=&quot;box&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mstyle displaystyle=&quot;true&quot; scriptlevel=&quot;0&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>I</mi><mi>P</mi></msub></mrow></mstyle></mrow></menclose><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>S</mi><mo stretchy=&quot;false&quot;>(</mo><mi>&amp;#x03BB;</mi><mo>,</mo><mi>&amp;#x03B8;</mi><mo>,</mo><mi>h</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>T</mi><mo stretchy=&quot;false&quot;>(</mo><mi>P</mi><mi>A</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></math>" role="presentation" style="display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size: 16px; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="27.328ex" height="3.6ex" viewBox="0 -1049.3 11766.1 1550" role="img" focusable="false" aria-hidden="true" style="vertical-align: -1.163ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#MJMATHI-49" x="0" y="0"></use><g transform="translate(440,-163)"><use transform="scale(0.707)" xlink:href="#MJMATHI-50" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMATHI-41" x="751" y="0"></use></g><use xlink:href="#MJMAIN-3D" x="1880" y="0"></use><g transform="translate(3214,0)"><g transform="translate(275,0)"><use xlink:href="#MJMATHI-49" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMATHI-50" x="622" y="-213"></use></g><line stroke-linecap="square" stroke-width="75" y2="37" y1="37" x1="37" x2="1584" transform="translate(0,884)"></line><line stroke-linecap="square" stroke-width="75" y1="37" x2="37" x1="37" y2="1347" transform="translate(1546,-426)"></line><line stroke-linecap="square" stroke-width="75" y2="37" y1="37" x1="37" x2="1584" transform="translate(0,-426)"></line><line stroke-linecap="square" stroke-width="75" y1="37" x2="37" x1="37" y2="1347" transform="translate(0,-426)"></line></g><g transform="translate(4836,0)"><use xlink:href="#MJMATHI-53" x="0" y="0"></use><use xlink:href="#MJMAIN-28" x="645" y="0"></use><use xlink:href="#MJMATHI-3BB" x="1035" y="0"></use><use xlink:href="#MJMAIN-2C" x="1618" y="0"></use><use xlink:href="#MJMATHI-3B8" x="2063" y="0"></use><use xlink:href="#MJMAIN-2C" x="2533" y="0"></use><use xlink:href="#MJMATHI-68" x="2978" y="0"></use><use xlink:href="#MJMAIN-29" x="3554" y="0"></use></g><g transform="translate(8780,0)"><use xlink:href="#MJMATHI-54" x="0" y="0"></use><use xlink:href="#MJMAIN-28" x="704" y="0"></use><use xlink:href="#MJMATHI-50" x="1094" y="0"></use><use xlink:href="#MJMATHI-41" x="1845" y="0"></use><use xlink:href="#MJMAIN-29" x="2596" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation" style="top: 0px; left: 0px; clip: rect(1px, 1px, 1px, 1px); user-select: none; position: absolute !important; padding: 1px 0px 0px !important; border: 0px !important; height: 1px !important; width: 1px !important; overflow: hidden !important; display: block !important; transition: none 0s ease 0s;"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>�</mi><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mi>�</mi></mrow></msub><mo>=</mo><menclose notation="box"><mrow class="MJX-TeXAtom-ORD"><mstyle displaystyle="true" scriptlevel="0"><mrow class="MJX-TeXAtom-ORD"><msub><mi>�</mi><mi>�</mi></msub></mrow></mstyle></mrow></menclose><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>�</mi><mo>,</mo><mi>�</mi><mo>,</mo><mi>ℎ</mi><mo stretchy="false">)</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>�</mi><mi>�</mi><mo stretchy="false">)</mo></mrow></math></span></span></span></span></p><p data-pid="ua3S_Hu4" style="margin: 1.4em 0px;">T表示衰减系数 表示某段路径上光照的衰减程度</p><p data-pid="KnwY7jB-" style="margin: 1.4em 0px;">S表示散射系数 表示有多少光散射的角度为θ，λ为波长，h</p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic3.zhimg.com/80/v2-b0a7d27e96882099d1698e3ef632c6ae_720w.webp" data-rawwidth="1172" data-rawheight="565" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="1172" data-original="https://pic3.zhimg.com/v2-b0a7d27e96882099d1698e3ef632c6ae_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-b0a7d27e96882099d1698e3ef632c6ae_b.jpg" data-original-token="v2-e02a5800ebfe6a25b07386bace6ab65a" height="565" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><p data-pid="MjMhIwRG" style="margin: 1.4em 0px;">实际上在路径 AB(也可能是斜的一条射线) 上有无数个 P 点，因此最终求解是对 AB 路径上每一个点的光照贡献进行累加 (求积分，不同高度不同密度)</p><p data-pid="jMNFeqSP" style="margin: 1.4em 0px;"><span class="ztext-math" data-eeimg="1" data-tex="\int_{A}^{B}I_{s} {T({CP})}{S(\lambda,\theta,h)} {T(PA)}ds"><span></span><span><span class="MathJax_Preview" style="color: inherit; display: contents;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mo>&amp;#x222B;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>A</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>B</mi></mrow></msubsup><msub><mi>I</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>s</mi></mrow></msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>T</mi><mo stretchy=&quot;false&quot;>(</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>C</mi><mi>P</mi></mrow><mo stretchy=&quot;false&quot;>)</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>S</mi><mo stretchy=&quot;false&quot;>(</mo><mi>&amp;#x03BB;</mi><mo>,</mo><mi>&amp;#x03B8;</mi><mo>,</mo><mi>h</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>T</mi><mo stretchy=&quot;false&quot;>(</mo><mi>P</mi><mi>A</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mi>d</mi><mi>s</mi></math>" role="presentation" style="display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size: 16px; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="30.766ex" height="3.484ex" viewBox="0 -1099.2 13246.5 1500.1" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.931ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#MJSZ1-222B" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMATHI-42" x="921" y="754"></use><use transform="scale(0.707)" xlink:href="#MJMATHI-41" x="668" y="-484"></use><g transform="translate(1455,0)"><use xlink:href="#MJMATHI-49" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMATHI-73" x="622" y="-213"></use></g><g transform="translate(2328,0)"><use xlink:href="#MJMATHI-54" x="0" y="0"></use><use xlink:href="#MJMAIN-28" x="704" y="0"></use><g transform="translate(1094,0)"><use xlink:href="#MJMATHI-43" x="0" y="0"></use><use xlink:href="#MJMATHI-50" x="760" y="0"></use></g><use xlink:href="#MJMAIN-29" x="2606" y="0"></use></g><g transform="translate(5323,0)"><use xlink:href="#MJMATHI-53" x="0" y="0"></use><use xlink:href="#MJMAIN-28" x="645" y="0"></use><use xlink:href="#MJMATHI-3BB" x="1035" y="0"></use><use xlink:href="#MJMAIN-2C" x="1618" y="0"></use><use xlink:href="#MJMATHI-3B8" x="2063" y="0"></use><use xlink:href="#MJMAIN-2C" x="2533" y="0"></use><use xlink:href="#MJMATHI-68" x="2978" y="0"></use><use xlink:href="#MJMAIN-29" x="3554" y="0"></use></g><g transform="translate(9267,0)"><use xlink:href="#MJMATHI-54" x="0" y="0"></use><use xlink:href="#MJMAIN-28" x="704" y="0"></use><use xlink:href="#MJMATHI-50" x="1094" y="0"></use><use xlink:href="#MJMATHI-41" x="1845" y="0"></use><use xlink:href="#MJMAIN-29" x="2596" y="0"></use></g><use xlink:href="#MJMATHI-64" x="12253" y="0"></use><use xlink:href="#MJMATHI-73" x="12776" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation" style="top: 0px; left: 0px; clip: rect(1px, 1px, 1px, 1px); user-select: none; position: absolute !important; padding: 1px 0px 0px !important; border: 0px !important; height: 1px !important; width: 1px !important; overflow: hidden !important; display: block !important; transition: none 0s ease 0s;"><math xmlns="http://www.w3.org/1998/Math/MathML"><msubsup><mo>∫</mo><mrow class="MJX-TeXAtom-ORD"><mi>�</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>�</mi></mrow></msubsup><msub><mi>�</mi><mrow class="MJX-TeXAtom-ORD"><mi>�</mi></mrow></msub><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mi>�</mi></mrow><mo stretchy="false">)</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>�</mi><mo>,</mo><mi>�</mi><mo>,</mo><mi>ℎ</mi><mo stretchy="false">)</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>�</mi><mi>�</mi><mo stretchy="false">)</mo></mrow><mi>�</mi><mi>�</mi></math></span></span></span></span></p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic2.zhimg.com/80/v2-9ea45776ec08e29c4975f503f854a30d_720w.webp" data-rawwidth="800" data-rawheight="230" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="800" data-original="https://pic2.zhimg.com/v2-9ea45776ec08e29c4975f503f854a30d_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-9ea45776ec08e29c4975f503f854a30d_b.jpg" data-original-token="v2-bb74f1805f00ed78d65febe91add0e3d" height="230" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><h2 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.2em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(2.33333em) 0px calc(1.16667em); clear: left; font-synthesis: style;">散射类型分2种</h2><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;">Rayleigh Scattering</h3><p data-pid="rhTRlfrf" style="margin: 1.4em 0px;">大小远小于光线波长的粒子，由于粒子比波长还要小很多，所以光的波长也会影响散射程度</p><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;">Mie Scattering</h3><p data-pid="48M7NYyg" style="margin: 1.4em 0px;">大小远大于光线波长的粒子，由于光的波长相较于这些粒子大小来说是可以忽略的，所以认为Mie Scattering和光线波长无关，Mie Scattering是太阳周围光晕的主要成因</p><h2 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.2em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(2.33333em) 0px calc(1.16667em); clear: left; font-synthesis: style;">散射方程</h2><p data-pid="BKs0FzI5" style="margin: 1.4em 0px;"><span class="ztext-math" data-eeimg="1" data-tex="{S(\lambda,\theta,h)} = \frac{\pi^2(n^2-1)^2}{2}\frac{{\rho(h)}}{N}\frac{1}{\lambda^4}(1+cos\theta^2)"><span></span><span><span class="MathJax_Preview" style="color: inherit; display: contents;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>S</mi><mo stretchy=&quot;false&quot;>(</mo><mi>&amp;#x03BB;</mi><mo>,</mo><mi>&amp;#x03B8;</mi><mo>,</mo><mi>h</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>=</mo><mfrac><mrow><msup><mi>&amp;#x03C0;</mi><mn>2</mn></msup><mo stretchy=&quot;false&quot;>(</mo><msup><mi>n</mi><mn>2</mn></msup><mo>&amp;#x2212;</mo><mn>1</mn><msup><mo stretchy=&quot;false&quot;>)</mo><mn>2</mn></msup></mrow><mn>2</mn></mfrac><mfrac><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>&amp;#x03C1;</mi><mo stretchy=&quot;false&quot;>(</mo><mi>h</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mi>N</mi></mfrac><mfrac><mn>1</mn><msup><mi>&amp;#x03BB;</mi><mn>4</mn></msup></mfrac><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo>+</mo><mi>c</mi><mi>o</mi><mi>s</mi><msup><mi>&amp;#x03B8;</mi><mn>2</mn></msup><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation" style="display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size: 16px; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="38.275ex" height="4.642ex" viewBox="0 -1348.5 16479.6 1998.8" role="img" focusable="false" aria-hidden="true" style="vertical-align: -1.51ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#MJMATHI-53" x="0" y="0"></use><use xlink:href="#MJMAIN-28" x="645" y="0"></use><use xlink:href="#MJMATHI-3BB" x="1035" y="0"></use><use xlink:href="#MJMAIN-2C" x="1618" y="0"></use><use xlink:href="#MJMATHI-3B8" x="2063" y="0"></use><use xlink:href="#MJMAIN-2C" x="2533" y="0"></use><use xlink:href="#MJMATHI-68" x="2978" y="0"></use><use xlink:href="#MJMAIN-29" x="3554" y="0"></use><use xlink:href="#MJMAIN-3D" x="4222" y="0"></use><g transform="translate(5000,0)"><g transform="translate(397,0)"><rect stroke="none" width="3368" height="60" x="0" y="220"></rect><g transform="translate(60,580)"><use transform="scale(0.707)" xlink:href="#MJMATHI-3C0" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="#MJMAIN-32" x="812" y="513"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-28" x="1028" y="0"></use><g transform="translate(1002,0)"><use transform="scale(0.707)" xlink:href="#MJMATHI-6E" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="#MJMAIN-32" x="849" y="513"></use></g><use transform="scale(0.707)" xlink:href="#MJMAIN-2212" x="2472" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-31" x="3250" y="0"></use><g transform="translate(2652,0)"><use transform="scale(0.707)" xlink:href="#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="#MJMAIN-32" x="550" y="675"></use></g></g><use transform="scale(0.707)" xlink:href="#MJMAIN-32" x="2131" y="-531"></use></g></g><g transform="translate(8887,0)"><g transform="translate(120,0)"><rect stroke="none" width="1444" height="60" x="0" y="220"></rect><g transform="translate(60,580)"><use transform="scale(0.707)" xlink:href="#MJMATHI-3C1" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-28" x="517" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMATHI-68" x="907" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-29" x="1483" y="0"></use></g><use transform="scale(0.707)" xlink:href="#MJMATHI-4E" x="577" y="-548"></use></g></g><g transform="translate(10571,0)"><g transform="translate(120,0)"><rect stroke="none" width="853" height="60" x="0" y="220"></rect><use transform="scale(0.707)" xlink:href="#MJMAIN-31" x="353" y="571"></use><g transform="translate(60,-541)"><use transform="scale(0.707)" xlink:href="#MJMATHI-3BB" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="#MJMAIN-34" x="825" y="596"></use></g></g></g><use xlink:href="#MJMAIN-28" x="11665" y="0"></use><use xlink:href="#MJMAIN-31" x="12054" y="0"></use><use xlink:href="#MJMAIN-2B" x="12777" y="0"></use><use xlink:href="#MJMATHI-63" x="13778" y="0"></use><use xlink:href="#MJMATHI-6F" x="14211" y="0"></use><use xlink:href="#MJMATHI-73" x="14697" y="0"></use><g transform="translate(15166,0)"><use xlink:href="#MJMATHI-3B8" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-32" x="663" y="513"></use></g><use xlink:href="#MJMAIN-29" x="16090" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation" style="top: 0px; left: 0px; clip: rect(1px, 1px, 1px, 1px); user-select: none; position: absolute !important; padding: 1px 0px 0px !important; border: 0px !important; height: 1px !important; width: 1px !important; overflow: hidden !important; display: block !important; transition: none 0s ease 0s;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>�</mi><mo>,</mo><mi>�</mi><mo>,</mo><mi>ℎ</mi><mo stretchy="false">)</mo></mrow><mo>=</mo><mfrac><mrow><msup><mi>�</mi><mn>2</mn></msup><mo stretchy="false">(</mo><msup><mi>�</mi><mn>2</mn></msup><mo>−</mo><mn>1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mn>2</mn></mfrac><mfrac><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>ℎ</mi><mo stretchy="false">)</mo></mrow><mi>�</mi></mfrac><mfrac><mn>1</mn><msup><mi>�</mi><mn>4</mn></msup></mfrac><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mi>�</mi><mi>�</mi><mi>�</mi><msup><mi>�</mi><mn>2</mn></msup><mo stretchy="false">)</mo></math></span></span></span></span></p><p data-pid="qVZl3Cr0" style="margin: 1.4em 0px;">λ光的波长(R680 G550 B440nm)，θ散射角度，h高度，n空气的折射率，N一个常数表示大气厚度，大气密度ρ(h)密度比，在海平面为1，随高度呈指数下降</p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic3.zhimg.com/80/v2-9b7f4c87846beafb09e53daa454d5e1a_720w.webp" data-rawwidth="1420" data-rawheight="947" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="1420" data-original="https://pic3.zhimg.com/v2-9b7f4c87846beafb09e53daa454d5e1a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-9b7f4c87846beafb09e53daa454d5e1a_b.jpg" data-original-token="v2-7821323ab66d8d7e6bc9d2aa51c25fff" height="947" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><p data-pid="oKYXP7BV" style="margin: 1.4em 0px;">散射方程主要分为，1散射系数，2相位函数，3大气密度比</p><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;">1 散射系数</h3><p data-pid="EazoI37k" style="margin: 1.4em 0px;"><span class="ztext-math" data-eeimg="1" data-tex="{S(\lambda,h)} = \frac{8\pi^2(n^2-1)^2}{3}\frac{{\rho(h)}}{N}\frac{1}{\lambda^4} "><span></span><span><span class="MathJax_Preview" style="color: inherit; display: contents;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>S</mi><mo stretchy=&quot;false&quot;>(</mo><mi>&amp;#x03BB;</mi><mo>,</mo><mi>h</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>=</mo><mfrac><mrow><mn>8</mn><msup><mi>&amp;#x03C0;</mi><mn>2</mn></msup><mo stretchy=&quot;false&quot;>(</mo><msup><mi>n</mi><mn>2</mn></msup><mo>&amp;#x2212;</mo><mn>1</mn><msup><mo stretchy=&quot;false&quot;>)</mo><mn>2</mn></msup></mrow><mn>3</mn></mfrac><mfrac><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>&amp;#x03C1;</mi><mo stretchy=&quot;false&quot;>(</mo><mi>h</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mi>N</mi></mfrac><mfrac><mn>1</mn><msup><mi>&amp;#x03BB;</mi><mn>4</mn></msup></mfrac></math>" role="presentation" style="display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size: 16px; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="25.791ex" height="4.642ex" viewBox="0 -1348.5 11104.5 1998.8" role="img" focusable="false" aria-hidden="true" style="vertical-align: -1.51ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#MJMATHI-53" x="0" y="0"></use><use xlink:href="#MJMAIN-28" x="645" y="0"></use><use xlink:href="#MJMATHI-3BB" x="1035" y="0"></use><use xlink:href="#MJMAIN-2C" x="1618" y="0"></use><use xlink:href="#MJMATHI-68" x="2063" y="0"></use><use xlink:href="#MJMAIN-29" x="2640" y="0"></use><use xlink:href="#MJMAIN-3D" x="3307" y="0"></use><g transform="translate(4085,0)"><g transform="translate(397,0)"><rect stroke="none" width="3722" height="60" x="0" y="220"></rect><g transform="translate(60,580)"><use transform="scale(0.707)" xlink:href="#MJMAIN-38" x="0" y="0"></use><g transform="translate(353,0)"><use transform="scale(0.707)" xlink:href="#MJMATHI-3C0" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="#MJMAIN-32" x="812" y="513"></use></g><use transform="scale(0.707)" xlink:href="#MJMAIN-28" x="1528" y="0"></use><g transform="translate(1356,0)"><use transform="scale(0.707)" xlink:href="#MJMATHI-6E" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="#MJMAIN-32" x="849" y="513"></use></g><use transform="scale(0.707)" xlink:href="#MJMAIN-2212" x="2972" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-31" x="3751" y="0"></use><g transform="translate(3006,0)"><use transform="scale(0.707)" xlink:href="#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="#MJMAIN-32" x="550" y="675"></use></g></g><use transform="scale(0.707)" xlink:href="#MJMAIN-33" x="2382" y="-530"></use></g></g><g transform="translate(8326,0)"><g transform="translate(120,0)"><rect stroke="none" width="1444" height="60" x="0" y="220"></rect><g transform="translate(60,580)"><use transform="scale(0.707)" xlink:href="#MJMATHI-3C1" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-28" x="517" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMATHI-68" x="907" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-29" x="1483" y="0"></use></g><use transform="scale(0.707)" xlink:href="#MJMATHI-4E" x="577" y="-548"></use></g></g><g transform="translate(10010,0)"><g transform="translate(120,0)"><rect stroke="none" width="853" height="60" x="0" y="220"></rect><use transform="scale(0.707)" xlink:href="#MJMAIN-31" x="353" y="571"></use><g transform="translate(60,-541)"><use transform="scale(0.707)" xlink:href="#MJMATHI-3BB" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="#MJMAIN-34" x="825" y="596"></use></g></g></g></g></svg><span class="MJX_Assistive_MathML" role="presentation" style="top: 0px; left: 0px; clip: rect(1px, 1px, 1px, 1px); user-select: none; position: absolute !important; padding: 1px 0px 0px !important; border: 0px !important; height: 1px !important; width: 1px !important; overflow: hidden !important; display: block !important; transition: none 0s ease 0s;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>�</mi><mo>,</mo><mi>ℎ</mi><mo stretchy="false">)</mo></mrow><mo>=</mo><mfrac><mrow><mn>8</mn><msup><mi>�</mi><mn>2</mn></msup><mo stretchy="false">(</mo><msup><mi>�</mi><mn>2</mn></msup><mo>−</mo><mn>1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mn>3</mn></mfrac><mfrac><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>ℎ</mi><mo stretchy="false">)</mo></mrow><mi>�</mi></mfrac><mfrac><mn>1</mn><msup><mi>�</mi><mn>4</mn></msup></mfrac></math></span></span></span></span></p><p data-pid="xwcpm6A7" style="margin: 1.4em 0px;"><span class="ztext-math" data-eeimg="1" data-tex="{S(\lambda,0)} = \frac{8\pi^2(n^2-1)^2}{3}\frac{{1}}{N}\frac{1}{\lambda^4}"><span></span><span><span class="MathJax_Preview" style="color: inherit; display: contents;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>S</mi><mo stretchy=&quot;false&quot;>(</mo><mi>&amp;#x03BB;</mi><mo>,</mo><mn>0</mn><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>=</mo><mfrac><mrow><mn>8</mn><msup><mi>&amp;#x03C0;</mi><mn>2</mn></msup><mo stretchy=&quot;false&quot;>(</mo><msup><mi>n</mi><mn>2</mn></msup><mo>&amp;#x2212;</mo><mn>1</mn><msup><mo stretchy=&quot;false&quot;>)</mo><mn>2</mn></msup></mrow><mn>3</mn></mfrac><mfrac><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>1</mn></mrow><mi>N</mi></mfrac><mfrac><mn>1</mn><msup><mi>&amp;#x03BB;</mi><mn>4</mn></msup></mfrac></math>" role="presentation" style="display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size: 16px; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="23.998ex" height="4.642ex" viewBox="0 -1348.5 10332.4 1998.8" role="img" focusable="false" aria-hidden="true" style="vertical-align: -1.51ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#MJMATHI-53" x="0" y="0"></use><use xlink:href="#MJMAIN-28" x="645" y="0"></use><use xlink:href="#MJMATHI-3BB" x="1035" y="0"></use><use xlink:href="#MJMAIN-2C" x="1618" y="0"></use><use xlink:href="#MJMAIN-30" x="2063" y="0"></use><use xlink:href="#MJMAIN-29" x="2564" y="0"></use><use xlink:href="#MJMAIN-3D" x="3231" y="0"></use><g transform="translate(4009,0)"><g transform="translate(397,0)"><rect stroke="none" width="3722" height="60" x="0" y="220"></rect><g transform="translate(60,580)"><use transform="scale(0.707)" xlink:href="#MJMAIN-38" x="0" y="0"></use><g transform="translate(353,0)"><use transform="scale(0.707)" xlink:href="#MJMATHI-3C0" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="#MJMAIN-32" x="812" y="513"></use></g><use transform="scale(0.707)" xlink:href="#MJMAIN-28" x="1528" y="0"></use><g transform="translate(1356,0)"><use transform="scale(0.707)" xlink:href="#MJMATHI-6E" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="#MJMAIN-32" x="849" y="513"></use></g><use transform="scale(0.707)" xlink:href="#MJMAIN-2212" x="2972" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-31" x="3751" y="0"></use><g transform="translate(3006,0)"><use transform="scale(0.707)" xlink:href="#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="#MJMAIN-32" x="550" y="675"></use></g></g><use transform="scale(0.707)" xlink:href="#MJMAIN-33" x="2382" y="-530"></use></g></g><g transform="translate(8250,0)"><g transform="translate(120,0)"><rect stroke="none" width="748" height="60" x="0" y="220"></rect><use transform="scale(0.707)" xlink:href="#MJMAIN-31" x="278" y="571"></use><use transform="scale(0.707)" xlink:href="#MJMATHI-4E" x="84" y="-548"></use></g></g><g transform="translate(9238,0)"><g transform="translate(120,0)"><rect stroke="none" width="853" height="60" x="0" y="220"></rect><use transform="scale(0.707)" xlink:href="#MJMAIN-31" x="353" y="571"></use><g transform="translate(60,-541)"><use transform="scale(0.707)" xlink:href="#MJMATHI-3BB" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="#MJMAIN-34" x="825" y="596"></use></g></g></g></g></svg><span class="MJX_Assistive_MathML" role="presentation" style="top: 0px; left: 0px; clip: rect(1px, 1px, 1px, 1px); user-select: none; position: absolute !important; padding: 1px 0px 0px !important; border: 0px !important; height: 1px !important; width: 1px !important; overflow: hidden !important; display: block !important; transition: none 0s ease 0s;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>�</mi><mo>,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><mo>=</mo><mfrac><mrow><mn>8</mn><msup><mi>�</mi><mn>2</mn></msup><mo stretchy="false">(</mo><msup><mi>�</mi><mn>2</mn></msup><mo>−</mo><mn>1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mn>3</mn></mfrac><mfrac><mrow class="MJX-TeXAtom-ORD"><mn>1</mn></mrow><mi>�</mi></mfrac><mfrac><mn>1</mn><msup><mi>�</mi><mn>4</mn></msup></mfrac></math></span></span></span></span></p><p data-pid="EovNrMTF" style="margin: 1.4em 0px;">在海平面上，是一个常数</p><p data-pid="yX4txdZp" style="margin: 1.4em 0px;">Rayleigh 0.005802f, 0.013558f, 0.033100f</p><p data-pid="nd7kiQM3" style="margin: 1.4em 0px;">Mie 来说 0.003996f, 0.003996f, 0.003996f</p><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;">2 相位函数</h3><p data-pid="cryFIPDS" style="margin: 1.4em 0px;"><span class="ztext-math" data-eeimg="1" data-tex="{P(\theta)} = \frac{3}{16\pi}(1+cos\theta^2)"><span></span><span><span class="MathJax_Preview" style="color: inherit; display: contents;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>P</mi><mo stretchy=&quot;false&quot;>(</mo><mi>&amp;#x03B8;</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>=</mo><mfrac><mn>3</mn><mrow><mn>16</mn><mi>&amp;#x03C0;</mi></mrow></mfrac><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo>+</mo><mi>c</mi><mi>o</mi><mi>s</mi><msup><mi>&amp;#x03B8;</mi><mn>2</mn></msup><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation" style="display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size: 16px; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="22.347ex" height="3.253ex" viewBox="0 -949.6 9621.7 1400.4" role="img" focusable="false" aria-hidden="true" style="vertical-align: -1.047ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#MJMATHI-50" x="0" y="0"></use><use xlink:href="#MJMAIN-28" x="751" y="0"></use><use xlink:href="#MJMATHI-3B8" x="1141" y="0"></use><use xlink:href="#MJMAIN-29" x="1610" y="0"></use><use xlink:href="#MJMAIN-3D" x="2277" y="0"></use><g transform="translate(3056,0)"><g transform="translate(397,0)"><rect stroke="none" width="1233" height="60" x="0" y="220"></rect><use transform="scale(0.707)" xlink:href="#MJMAIN-33" x="621" y="593"></use><g transform="translate(60,-376)"><use transform="scale(0.707)" xlink:href="#MJMAIN-31"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-36" x="500" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMATHI-3C0" x="1001" y="0"></use></g></g></g><use xlink:href="#MJMAIN-28" x="4807" y="0"></use><use xlink:href="#MJMAIN-31" x="5196" y="0"></use><use xlink:href="#MJMAIN-2B" x="5919" y="0"></use><use xlink:href="#MJMATHI-63" x="6920" y="0"></use><use xlink:href="#MJMATHI-6F" x="7353" y="0"></use><use xlink:href="#MJMATHI-73" x="7839" y="0"></use><g transform="translate(8308,0)"><use xlink:href="#MJMATHI-3B8" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-32" x="663" y="513"></use></g><use xlink:href="#MJMAIN-29" x="9232" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation" style="top: 0px; left: 0px; clip: rect(1px, 1px, 1px, 1px); user-select: none; position: absolute !important; padding: 1px 0px 0px !important; border: 0px !important; height: 1px !important; width: 1px !important; overflow: hidden !important; display: block !important; transition: none 0s ease 0s;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>�</mi><mo stretchy="false">)</mo></mrow><mo>=</mo><mfrac><mn>3</mn><mrow><mn>16</mn><mi>�</mi></mrow></mfrac><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mi>�</mi><mi>�</mi><mi>�</mi><msup><mi>�</mi><mn>2</mn></msup><mo stretchy="false">)</mo></math></span></span></span></span></p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic2.zhimg.com/80/v2-92ccbf1aced464600f90d52db6afb819_720w.webp" data-rawwidth="720" data-rawheight="260" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="720" data-original="https://pic2.zhimg.com/v2-92ccbf1aced464600f90d52db6afb819_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-92ccbf1aced464600f90d52db6afb819_b.jpg" data-original-token="v2-c9958ed39a8b2844f09e8a99586ebf63" height="260" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;">3 大气密度比</h3><p data-pid="_f_jTw-o" style="margin: 1.4em 0px;"><span class="ztext-math" data-eeimg="1" data-tex="{\rho(h)} = exp(-\frac{h}{H})"><span></span><span><span class="MathJax_Preview" style="color: inherit; display: contents;"></span><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>&amp;#x03C1;</mi><mo stretchy=&quot;false&quot;>(</mo><mi>h</mi><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>=</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo stretchy=&quot;false&quot;>(</mo><mo>&amp;#x2212;</mo><mfrac><mi>h</mi><mi>H</mi></mfrac><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation" style="display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size: 16px; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.944ex" height="3.368ex" viewBox="0 -999.4 7295.3 1450.3" role="img" focusable="false" aria-hidden="true" style="vertical-align: -1.047ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#MJMATHI-3C1" x="0" y="0"></use><use xlink:href="#MJMAIN-28" x="517" y="0"></use><use xlink:href="#MJMATHI-68" x="907" y="0"></use><use xlink:href="#MJMAIN-29" x="1483" y="0"></use><use xlink:href="#MJMAIN-3D" x="2150" y="0"></use><use xlink:href="#MJMATHI-65" x="3207" y="0"></use><use xlink:href="#MJMATHI-78" x="3673" y="0"></use><use xlink:href="#MJMATHI-70" x="4246" y="0"></use><use xlink:href="#MJMAIN-28" x="4749" y="0"></use><use xlink:href="#MJMAIN-2212" x="5139" y="0"></use><g transform="translate(5917,0)"><g transform="translate(120,0)"><rect stroke="none" width="748" height="60" x="0" y="220"></rect><use transform="scale(0.707)" xlink:href="#MJMATHI-68" x="240" y="582"></use><use transform="scale(0.707)" xlink:href="#MJMATHI-48" x="84" y="-548"></use></g></g><use xlink:href="#MJMAIN-29" x="6905" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation" style="top: 0px; left: 0px; clip: rect(1px, 1px, 1px, 1px); user-select: none; position: absolute !important; padding: 1px 0px 0px !important; border: 0px !important; height: 1px !important; width: 1px !important; overflow: hidden !important; display: block !important; transition: none 0s ease 0s;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi>�</mi><mo stretchy="false">(</mo><mi>ℎ</mi><mo stretchy="false">)</mo></mrow><mo>=</mo><mi>�</mi><mi>�</mi><mi>�</mi><mo stretchy="false">(</mo><mo>−</mo><mfrac><mi>ℎ</mi><mi>�</mi></mfrac><mo stretchy="false">)</mo></math></span></span></span></span></p><p data-pid="8jXaJpNt" style="margin: 1.4em 0px;">Rayleigh 来说，H= 8500米</p><p data-pid="I1NRjlai" style="margin: 1.4em 0px;">Mie 来说，H = 1200米</p><p data-pid="jugx7q32" style="margin: 1.4em 0px;">颜色来表示Rayleigh的散射</p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic2.zhimg.com/80/v2-d3bad82621a1a6abfb103bbf3e6e4bb9_720w.webp" data-rawwidth="327" data-rawheight="668" data-size="normal" data-caption="" class="content_image lazy" width="327" data-actualsrc="https://pic2.zhimg.com/v2-d3bad82621a1a6abfb103bbf3e6e4bb9_b.jpg" data-original-token="v2-216a8b568e6ab2849961da5ef5d54a01" height="668" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;">Absorption</h3><p data-pid="ID-VGRWC" style="margin: 1.4em 0px;">除了发生散射，大气中还有臭氧和甲烷吸收</p><p data-pid="zSDigSKf" style="margin: 1.4em 0px;">臭氧(O3)臭氧主要吸收短波紫外线</p><p data-pid="L5bWeeiQ" style="margin: 1.4em 0px;">甲烷（CH4）甲烷是一种吸收红外光而反射蓝光的气体</p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic1.zhimg.com/80/v2-a0feec80c9cad9c9c45c2669f828fbb4_720w.webp" data-rawwidth="1057" data-rawheight="228" data-size="normal" class="origin_image zh-lightbox-thumb lazy" width="1057" data-original="https://pic1.zhimg.com/v2-a0feec80c9cad9c9c45c2669f828fbb4_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-a0feec80c9cad9c9c45c2669f828fbb4_b.jpg" data-original-token="v2-015ffede7227bb535b9973668a2778af" height="228" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div><figcaption style="color: rgb(153, 153, 153); font-size: 0.9em; line-height: 1.5; margin-top: calc(0.666667em); padding: 0px 1em; text-align: center;">Ragleigh没有吸收</figcaption></figure><p class="ztext-empty-paragraph" style="margin: -0.8em 0px;"><br></p><p data-pid="rrRwPkpn" style="margin: 1.4em 0px;">用颜色来表示下Absorption</p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic3.zhimg.com/80/v2-fc36312783255a8b3395da8b953feece_720w.webp" data-rawwidth="327" data-rawheight="668" data-size="normal" data-caption="" class="content_image lazy" width="327" data-actualsrc="https://pic3.zhimg.com/v2-fc36312783255a8b3395da8b953feece_b.jpg" data-original-token="v2-9b34c5b22d43da6b31f2cb3be4e0bd0f" height="668" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><p data-pid="T3WanxUR" style="margin: 1.4em 0px;">公式表</p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic4.zhimg.com/80/v2-6bdd2552d797df56017e06ced889d527_720w.webp" data-rawwidth="1325" data-rawheight="668" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="1325" data-original="https://pic4.zhimg.com/v2-6bdd2552d797df56017e06ced889d527_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-6bdd2552d797df56017e06ced889d527_b.jpg" data-original-token="v2-e0145bddb302176a7bee03aa00d80eff" height="668" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><p data-pid="vXWYTYnc" style="margin: 1.4em 0px;">伪代码</p><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">Function Transmittance(float3 A, float3 B)
{
    float   SAMPLE=64//采样次数
    float   distance=length(A,B)
    float3  dir=B-A
    float   ds=distance/SAMPLE
    float3  p = A + (dir * ds) * 0.5;
    float3 result=0
    //算积分
    for(int i=0; i&lt;SAMPLE; i++)
    {
        float h = length(p)
        float3 extinctionMie = MieExtinction(h);
        float3 extinctionRay = RayleighCoefficient(h)
        float3 extinctionOzo = OzoneAbsorption(h)
        result += (extinctionMie + extinctionRay + extinctionOzo)*ds
    }
    return exp(-result)
}
float3 eyePos
float3 viewDir
float3 lightDir
float3 P = eyePos + (viewDir * ds) * 0.5
float  cos⁡  = dot(lightDir, viewDir)
float3 RayleighScattering = RayleighCoefficient(h) * RayleiPhase(cos⁡ )
float3 MieScattering = MieCoefficient(h) * MiePhase(cos⁡ )
Single Scattering = Transmittance(P,lightDir) *(RayleighScattering+MieScattering) * Transmittance(eyePos,P)</code></pre></div><h2 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.2em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(2.33333em) 0px calc(1.16667em); clear: left; font-synthesis: style;"><b style="font-synthesis: style; font-weight: 600;">Multi Scattering</b></h2><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;">微分立体角</h3><p data-pid="KnYmKpE9" style="margin: 1.4em 0px;">在讲解多次散射，需要对微分立体角有一个了解，好理解能量守恒</p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic1.zhimg.com/80/v2-0689af62df75dbee47c66ce617032cb4_720w.webp" data-rawwidth="1206" data-rawheight="684" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="1206" data-original="https://pic1.zhimg.com/v2-0689af62df75dbee47c66ce617032cb4_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-0689af62df75dbee47c66ce617032cb4_b.jpg" data-original-token="v2-e8c445d618739cfd6ddb9e0f4f874151" height="684" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><figure data-size="normal" style="margin: calc(2.24em) 0px 1.4em;"><div><img src="https://pic2.zhimg.com/80/v2-c2374fadda2b706be2a25b619d64831d_720w.webp" data-rawwidth="457" data-rawheight="308" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="457" data-original="https://pic2.zhimg.com/v2-c2374fadda2b706be2a25b619d64831d_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-c2374fadda2b706be2a25b619d64831d_b.jpg" data-original-token="v2-5c4fec28da93bad4f53a3196ef5fff2d" height="308" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><p data-pid="OP3sj3n9" style="margin: 1.4em 0px;">整个球体的立体角就是4π</p><p data-pid="Z-UCV8nU" style="margin: 1.4em 0px;">微分立体角就是A/(r*r) 面积除以半径的平方</p><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;"><b style="font-synthesis: style; font-weight: 600;">辐射度量学</b></h3><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic3.zhimg.com/80/v2-155757bf9c89a294d6ea01b944714d1a_720w.webp" data-rawwidth="901" data-rawheight="665" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="901" data-original="https://pic3.zhimg.com/v2-155757bf9c89a294d6ea01b944714d1a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-155757bf9c89a294d6ea01b944714d1a_b.jpg" data-original-token="v2-0d8b7faf475c44bffc675e42434cf908" height="665" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><p class="ztext-empty-paragraph" style="margin: -0.8em 0px;"><br></p><p data-pid="ITHaXyWg" style="margin: 1.4em 0px;">辐射强度(Radiant Intensity) 是从光源出发，每单位立体角上的功率（亮度）</p><p data-pid="690kYSfK" style="margin: 1.4em 0px;">辐照度(Irradiance) 是入射<b style="font-synthesis: style; font-weight: 600;">投影</b>到单位面积上的功率（光照、辐射通量）</p><p data-pid="C4zbZxFP" style="margin: 1.4em 0px;">辐射(Radiance) 是描述光在环境中分布的基本场量，辐射描述<span> </span><b style="font-synthesis: style; font-weight: 600;">每单位立体角、每单位垂直面积的功率</b></p><p data-pid="dU8bcj7O" style="margin: 1.4em 0px;">总结：假设从光源总的辐射强度<b style="font-synthesis: style; font-weight: 600;">Radiant Intensity</b>为1，半径为2的立体角的辐照度<b style="font-synthesis: style; font-weight: 600;">Irradiance</b>就是1/(4π2^2)，</p><p data-pid="945kieFU" style="margin: 1.4em 0px;">辐射Radiance就是1/(4π2^2)<i>dw</i>,每个微分立体角可以接受到的能量</p><p data-pid="22kNjc21" style="margin: 1.4em 0px;">比如我们要算一个半球面能接受多少光照，直接做一个积分，就可以直接算出来，这样计算的光照能量守恒</p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic4.zhimg.com/80/v2-3682e1edd1df122a96c19df300d2ff23_720w.webp" data-rawwidth="1221" data-rawheight="736" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="1221" data-original="https://pic4.zhimg.com/v2-3682e1edd1df122a96c19df300d2ff23_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-3682e1edd1df122a96c19df300d2ff23_b.jpg" data-original-token="v2-0297d007832de337f9431ccc90cfd3d7" height="736" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;">多散次射的经过</h3><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic1.zhimg.com/80/v2-ab0f3aec445c972ac4fe71e99efeb6f0_720w.webp" data-rawwidth="1081" data-rawheight="339" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="1081" data-original="https://pic1.zhimg.com/v2-ab0f3aec445c972ac4fe71e99efeb6f0_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-ab0f3aec445c972ac4fe71e99efeb6f0_b.jpg" data-original-token="v2-7cf541b4db6114f6b73717189886ea74" height="339" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><p data-pid="wYOY0cUO" style="margin: 1.4em 0px;">总的来说，a算出单次散射，b加上地面的反射，c做一个球面的积分，d把整个视线路径做一个积分，求出有多少光可以到眼睛里</p><h2 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.2em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(2.33333em) 0px calc(1.16667em); clear: left; font-synthesis: style;">Bruneton2017</h2><div class="RichText-LinkCardContainer"><a target="_blank" href="https://link.zhihu.com/?target=https%3A//github.com/ebruneton/precomputed_atmospheric_scattering" data-draft-node="block" data-draft-type="link-card" data-text="https://github.com/ebruneton/precomputed_atmospheric_scattering" class="LinkCard new css-1wr1m8" data-za-detail-view-id="172" style="color: inherit !important; text-decoration: none; -webkit-box-align: center; align-items: center; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; background-color: rgb(246, 246, 246); border-radius: 8px; box-sizing: border-box; flex-direction: row; margin: 16px auto; max-width: 100%; min-height: 84px; overflow: hidden; padding: 12px 12px 9px; position: relative; width: 390px; border: none !important;"><span class="LinkCard-contents" style="-webkit-box-flex: 1; display: block; flex: 1 1 auto; position: relative;"><span class="LinkCard-title two-line" style="-webkit-line-clamp: 2; -webkit-box-orient: vertical; color: rgb(18, 18, 18); display: -webkit-box; font-size: 15px; font-weight: 500; line-height: 20px; max-height: 40px; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px;">https://github.com/ebruneton/precomputed_atmospheric_scattering</span><span class="LinkCard-desc" style="-webkit-line-clamp: 1; -webkit-box-orient: vertical; color: rgb(153, 153, 153); display: -webkit-box; font-size: 13px; height: 18px; line-height: 18px; overflow: hidden; text-overflow: ellipsis; word-break: break-all;"><span style="display: inline-flex; align-items: center;">​<svg width="14" height="14" viewBox="0 0 24 24" class="Zi Zi--InsertLink" fill="currentColor"><path fill-rule="evenodd" d="M5.327 18.883a3.005 3.005 0 0 1 0-4.25l2.608-2.607a.75.75 0 1 0-1.06-1.06l-2.608 2.607a4.505 4.505 0 0 0 6.37 6.37l2.608-2.607a.75.75 0 0 0-1.06-1.06l-2.608 2.607a3.005 3.005 0 0 1-4.25 0Zm5.428-11.799a.75.75 0 0 0 1.06 1.06L14.48 5.48a3.005 3.005 0 0 1 4.25 4.25l-2.665 2.665a.75.75 0 0 0 1.061 1.06l2.665-2.664a4.505 4.505 0 0 0-6.371-6.372l-2.665 2.665Zm5.323 2.117a.75.75 0 1 0-1.06-1.06l-7.072 7.07a.75.75 0 0 0 1.061 1.06l7.071-7.07Z" clip-rule="evenodd"></path></svg></span>github.com/ebruneton/precomputed_atmospheric_scattering</span></span></a></div><p data-pid="VJVVMWEm" style="margin: 1.4em 0px;">参考了Bruneton的代码，功能很全，仅需自己修改采样shadow</p><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">伪代码
ComputeTransmittanceLUT()
ComputeDirectIrradianceLUT()
ComputeSingleScatteringLUT()
for (uint order = 2; order &lt;= numScatteringOrders; order++) {
	ComputeScatteringDensity()// order&gt;=2计算间接光照， order&gt;2地球表面反射光
	ComputeIndirectIrradiance()//地球表面反射光
	ComputeMultipleScattering()//PA积分
}</code></pre></div><p data-pid="apGGQLmy" style="margin: 1.4em 0px;">优点就是一次计算完各个方向r(高度), mu(视角天顶角), mu_s(太阳天顶角), nu(视线和太阳的夹角)</p><p data-pid="BFY6KPuJ" style="margin: 1.4em 0px;">并且把mu_s和nu压缩到一个变量里面</p><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">Number frag_coord_nu = floor(frag_coord.x / Number(SCATTERING_TEXTURE_MU_S_SIZE));
Number frag_coord_mu_s = fmod(frag_coord.x, Number(SCATTERING_TEXTURE_MU_S_SIZE))</code></pre></div><p data-pid="WrfhSPDf" style="margin: 1.4em 0px;">保存结果到一个3DTexture，直接采样就行了</p><p data-pid="jztPF3Ik" style="margin: 1.4em 0px;">缺点就是如果需要修改默认参数，就要重新渲染一次，消耗巨大，PC都卡，移动端更受不了</p><p class="ztext-empty-paragraph" style="margin: -0.8em 0px;"><br></p><h2 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.2em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(2.33333em) 0px calc(1.16667em); clear: left; font-synthesis: style;">UnrealEngineSkyAtmosphere的LUT预处理</h2><div class="RichText-LinkCardContainer"><a target="_blank" href="https://link.zhihu.com/?target=https%3A//github.com/sebh/UnrealEngineSkyAtmosphere" data-draft-node="block" data-draft-type="link-card" data-text="GitHub - sebh/UnrealEngineSkyAtmosphere: Unreal Engine Sky Atmosphere Rendering Technique" class="LinkCard new css-1wr1m8" data-za-detail-view-id="172" style="color: inherit !important; text-decoration: none; -webkit-box-align: center; align-items: center; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; background-color: rgb(246, 246, 246); border-radius: 8px; box-sizing: border-box; flex-direction: row; margin: 16px auto; max-width: 100%; min-height: 84px; overflow: hidden; padding: 12px 12px 9px; position: relative; width: 390px; border: none !important;"><span class="LinkCard-contents" style="-webkit-box-flex: 1; display: block; flex: 1 1 auto; position: relative;"><span class="LinkCard-title two-line" style="-webkit-line-clamp: 2; -webkit-box-orient: vertical; color: rgb(18, 18, 18); display: -webkit-box; font-size: 15px; font-weight: 500; line-height: 20px; max-height: 40px; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px;">GitHub - sebh/UnrealEngineSkyAtmosphere: Unreal Engine Sky Atmosphere Rendering Technique</span><span class="LinkCard-desc" style="-webkit-line-clamp: 1; -webkit-box-orient: vertical; color: rgb(153, 153, 153); display: -webkit-box; font-size: 13px; height: 18px; line-height: 18px; overflow: hidden; text-overflow: ellipsis; word-break: break-all;"><span style="display: inline-flex; align-items: center;">​<svg width="14" height="14" viewBox="0 0 24 24" class="Zi Zi--InsertLink" fill="currentColor"><path fill-rule="evenodd" d="M5.327 18.883a3.005 3.005 0 0 1 0-4.25l2.608-2.607a.75.75 0 1 0-1.06-1.06l-2.608 2.607a4.505 4.505 0 0 0 6.37 6.37l2.608-2.607a.75.75 0 0 0-1.06-1.06l-2.608 2.607a3.005 3.005 0 0 1-4.25 0Zm5.428-11.799a.75.75 0 0 0 1.06 1.06L14.48 5.48a3.005 3.005 0 0 1 4.25 4.25l-2.665 2.665a.75.75 0 0 0 1.061 1.06l2.665-2.664a4.505 4.505 0 0 0-6.371-6.372l-2.665 2.665Zm5.323 2.117a.75.75 0 1 0-1.06-1.06l-7.072 7.07a.75.75 0 0 0 1.061 1.06l7.071-7.07Z" clip-rule="evenodd"></path></svg></span>github.com/sebh/UnrealEngineSkyAtmosphere</span></span></a></div><p data-pid="Fsnu7I1c" style="margin: 1.4em 0px;">主要需要计算4个LUT</p><p data-pid="0y_e8Ndf" style="margin: 1.4em 0px;">TransmittanceLUT MultipleScatteringLUT Sky-ViewLUT AerialPerspectiveLUT</p><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;">TransmittanceLUT</h3><p data-pid="N9InagLF" style="margin: 1.4em 0px;">uv 分别表示<span> </span><b style="font-synthesis: style; font-weight: 600;"><i>高度（r）</i></b>和<b style="font-synthesis: style; font-weight: 600;"><i>视角</i></b>天顶角（mu）</p><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">[numthreads(8, 8, 1)]
void IntergalTransmittanceLUT(uint3 id: SV_DispatchThreadID)
{
    float2 pixPos = id.xy + 0.5f;

    AtmosphereParameters Atmosphere = GetAtmosphereParameters();

    // Compute camera position from LUT coords
    float2 uv = (pixPos) / float2(TRANSMITTANCE_TEXTURE_WIDTH, TRANSMITTANCE_TEXTURE_HEIGHT);
    float viewHeight;
    float viewZenithCosAngle;
    UvToLutTransmittanceParams(Atmosphere, viewHeight, viewZenithCosAngle, uv);

    //  A few extra needed constants
    float3 WorldPos = float3(0.0f, viewHeight, 0.0f);
    float3 WorldDir = float3(sqrt(1.0 - viewZenithCosAngle * viewZenithCosAngle), viewZenithCosAngle, 0.0f);

    const bool ground = false;
    const float SampleCountIni = 40.0f; // Can go a low as 10 sample but energy lost starts to be visible.
    const float DepthBufferValue = -1.0;
    const bool VariableSampleCount = false;
    const bool MieRayPhase = false;
    float3 transmittance = exp(-IntegrateScatteredLuminance(uv, WorldPos, WorldDir, sun_direction, Atmosphere,
                                                            ground, SampleCountIni, DepthBufferValue,
                                                            VariableSampleCount, MieRayPhase).OpticalDepth);

    _TransmittanceLUT[id.xy] = float4(transmittance, 1.0f);
}</code></pre></div><p data-pid="mkEFtHAs" style="margin: 1.4em 0px;">代码很简单，就是遍历 高度和视角天顶角，太阳朝向已知，其他都可以算出来，把透射记录到Texture里面就行</p><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">void UvToLutTransmittanceParams(AtmosphereParameters Atmosphere, out float viewHeight, out float viewZenithCosAngle, in float2 uv)
{
	//uv = float2(fromSubUvsToUnit(uv.x, TRANSMITTANCE_TEXTURE_WIDTH), fromSubUvsToUnit(uv.y, TRANSMITTANCE_TEXTURE_HEIGHT)); // No real impact so off
	float x_mu = uv.x;
	float x_r = uv.y;

	float H = sqrt(Atmosphere.TopRadius * Atmosphere.TopRadius - Atmosphere.BottomRadius * Atmosphere.BottomRadius);
	float rho = H * x_r;
	viewHeight = sqrt(rho * rho + Atmosphere.BottomRadius * Atmosphere.BottomRadius);

	float d_min = Atmosphere.TopRadius - viewHeight;
	float d_max = rho + H;
	float d = d_min + x_mu * (d_max - d_min);
	viewZenithCosAngle = d == 0.0 ? 1.0f : (H * H - rho * rho - d * d) / (2.0 * viewHeight * d);
	viewZenithCosAngle = clamp(viewZenithCosAngle, -1.0, 1.0);
}</code></pre></div><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic1.zhimg.com/80/v2-2cc733eb7f6620dc8d015d62c4541580_720w.webp" data-rawwidth="996" data-rawheight="599" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="996" data-original="https://pic1.zhimg.com/v2-2cc733eb7f6620dc8d015d62c4541580_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-2cc733eb7f6620dc8d015d62c4541580_b.jpg" data-original-token="v2-984776c1fed8512b928ecb6772f05d81" height="599" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><p data-pid="2sPJD31f" style="margin: 1.4em 0px;">UvToLutTransmittanceParams把r和mu压缩到一个最大范围里面用来提高精度</p><p data-pid="_3-To1ow" style="margin: 1.4em 0px;">mu视线角度长度范围就是d_min 和 d_max</p><p data-pid="_gsYSKD5" style="margin: 1.4em 0px;"><span class="ztext-math" data-eeimg="1" data-tex="H点坐标=(d*(1-\mu^{2})^{0.5}，r+d*\mu)"><span></span><span><span class="MathJax_Preview" style="color: inherit; display: contents;"></span><span class="MathJax_SVG" id="MathJax-Element-9-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>H</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x70B9;</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x5750;</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x6807;</mo></mrow><mo>=</mo><mo stretchy=&quot;false&quot;>(</mo><mi>d</mi><mo>&amp;#x2217;</mo><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo>&amp;#x2212;</mo><msup><mi>&amp;#x03BC;</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>2</mn></mrow></msup><msup><mo stretchy=&quot;false&quot;>)</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>0.5</mn></mrow></msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#xFF0C;</mo></mrow><mi>r</mi><mo>+</mo><mi>d</mi><mo>&amp;#x2217;</mo><mi>&amp;#x03BC;</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation" style="display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size: 16px; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="37.098ex" height="2.905ex" viewBox="0 -899.7 15972.7 1250.8" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.815ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#MJMATHI-48" x="0" y="0"></use><g transform="translate(888,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(49.871) matrix(1 0 0 -1 0 0)">点</text></g><g transform="translate(1686,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(49.871) matrix(1 0 0 -1 0 0)">坐</text></g><g transform="translate(2484,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(49.871) matrix(1 0 0 -1 0 0)">标</text></g><use xlink:href="#MJMAIN-3D" x="3560" y="0"></use><use xlink:href="#MJMAIN-28" x="4616" y="0"></use><use xlink:href="#MJMATHI-64" x="5005" y="0"></use><use xlink:href="#MJMAIN-2217" x="5751" y="0"></use><use xlink:href="#MJMAIN-28" x="6474" y="0"></use><use xlink:href="#MJMAIN-31" x="6863" y="0"></use><use xlink:href="#MJMAIN-2212" x="7586" y="0"></use><g transform="translate(8587,0)"><use xlink:href="#MJMATHI-3BC" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-32" x="853" y="513"></use></g><g transform="translate(9644,0)"><use xlink:href="#MJMAIN-29" x="0" y="0"></use><g transform="translate(389,362)"><use transform="scale(0.707)" xlink:href="#MJMAIN-30"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-2E" x="500" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-35" x="779" y="0"></use></g></g><g transform="translate(11038,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(49.871) matrix(1 0 0 -1 0 0)">，</text></g><use xlink:href="#MJMATHI-72" x="11836" y="0"></use><use xlink:href="#MJMAIN-2B" x="12510" y="0"></use><use xlink:href="#MJMATHI-64" x="13511" y="0"></use><use xlink:href="#MJMAIN-2217" x="14257" y="0"></use><use xlink:href="#MJMATHI-3BC" x="14979" y="0"></use><use xlink:href="#MJMAIN-29" x="15583" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation" style="top: 0px; left: 0px; clip: rect(1px, 1px, 1px, 1px); user-select: none; position: absolute !important; padding: 1px 0px 0px !important; border: 0px !important; height: 1px !important; width: 1px !important; overflow: hidden !important; display: block !important; transition: none 0s ease 0s;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>�</mi><mrow class="MJX-TeXAtom-ORD"><mo>点</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo>坐</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo>标</mo></mrow><mo>=</mo><mo stretchy="false">(</mo><mi>�</mi><mo>∗</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>�</mi><mrow class="MJX-TeXAtom-ORD"><mn>2</mn></mrow></msup><msup><mo stretchy="false">)</mo><mrow class="MJX-TeXAtom-ORD"><mn>0.5</mn></mrow></msup><mrow class="MJX-TeXAtom-ORD"><mo>，</mo></mrow><mi>�</mi><mo>+</mo><mi>�</mi><mo>∗</mo><mi>�</mi><mo stretchy="false">)</mo></math></span></span></span></span></p><p data-pid="fTy8sgw0" style="margin: 1.4em 0px;"><span class="ztext-math" data-eeimg="1" data-tex="|\bar{H}|={ (d*(1-\mu^{2})^{0.5})^2+(r+d*\mu)^2}=d^2+r^2+2rd\mu"><span></span><span><span class="MathJax_Preview" style="color: inherit; display: contents;"></span><span class="MathJax_SVG" id="MathJax-Element-10-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>H</mi><mo stretchy=&quot;false&quot;>&amp;#x00AF;</mo></mover></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mo>=</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>(</mo><mi>d</mi><mo>&amp;#x2217;</mo><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo>&amp;#x2212;</mo><msup><mi>&amp;#x03BC;</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>2</mn></mrow></msup><msup><mo stretchy=&quot;false&quot;>)</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>0.5</mn></mrow></msup><msup><mo stretchy=&quot;false&quot;>)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy=&quot;false&quot;>(</mo><mi>r</mi><mo>+</mo><mi>d</mi><mo>&amp;#x2217;</mo><mi>&amp;#x03BC;</mi><msup><mo stretchy=&quot;false&quot;>)</mo><mn>2</mn></msup></mrow><mo>=</mo><msup><mi>d</mi><mn>2</mn></msup><mo>+</mo><msup><mi>r</mi><mn>2</mn></msup><mo>+</mo><mn>2</mn><mi>r</mi><mi>d</mi><mi>&amp;#x03BC;</mi></math>" role="presentation" style="display: inline-block; font-style: normal; font-weight: normal; line-height: normal; font-size: 16px; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="55.72ex" height="2.905ex" viewBox="0 -899.7 23990.5 1250.8" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.815ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#MJMAIN-7C" x="0" y="0"></use><g transform="translate(278,0)"><use xlink:href="#MJMATHI-48" x="0" y="0"></use><use xlink:href="#MJMAIN-AF" x="286" y="215"></use></g><use xlink:href="#MJMAIN-7C" x="1167" y="0"></use><use xlink:href="#MJMAIN-3D" x="1723" y="0"></use><g transform="translate(2779,0)"><use xlink:href="#MJMAIN-28" x="0" y="0"></use><use xlink:href="#MJMATHI-64" x="389" y="0"></use><use xlink:href="#MJMAIN-2217" x="1135" y="0"></use><use xlink:href="#MJMAIN-28" x="1857" y="0"></use><use xlink:href="#MJMAIN-31" x="2247" y="0"></use><use xlink:href="#MJMAIN-2212" x="2970" y="0"></use><g transform="translate(3970,0)"><use xlink:href="#MJMATHI-3BC" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-32" x="853" y="513"></use></g><g transform="translate(5028,0)"><use xlink:href="#MJMAIN-29" x="0" y="0"></use><g transform="translate(389,362)"><use transform="scale(0.707)" xlink:href="#MJMAIN-30"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-2E" x="500" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-35" x="779" y="0"></use></g></g><g transform="translate(6422,0)"><use xlink:href="#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-32" x="550" y="513"></use></g><use xlink:href="#MJMAIN-2B" x="7488" y="0"></use><use xlink:href="#MJMAIN-28" x="8488" y="0"></use><use xlink:href="#MJMATHI-72" x="8878" y="0"></use><use xlink:href="#MJMAIN-2B" x="9552" y="0"></use><use xlink:href="#MJMATHI-64" x="10552" y="0"></use><use xlink:href="#MJMAIN-2217" x="11298" y="0"></use><use xlink:href="#MJMATHI-3BC" x="12021" y="0"></use><g transform="translate(12624,0)"><use xlink:href="#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-32" x="550" y="513"></use></g></g><use xlink:href="#MJMAIN-3D" x="16525" y="0"></use><g transform="translate(17581,0)"><use xlink:href="#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-32" x="741" y="513"></use></g><use xlink:href="#MJMAIN-2B" x="18782" y="0"></use><g transform="translate(19783,0)"><use xlink:href="#MJMATHI-72" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#MJMAIN-32" x="638" y="513"></use></g><use xlink:href="#MJMAIN-2B" x="20910" y="0"></use><use xlink:href="#MJMAIN-32" x="21911" y="0"></use><use xlink:href="#MJMATHI-72" x="22411" y="0"></use><use xlink:href="#MJMATHI-64" x="22863" y="0"></use><use xlink:href="#MJMATHI-3BC" x="23386" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation" style="top: 0px; left: 0px; clip: rect(1px, 1px, 1px, 1px); user-select: none; position: absolute !important; padding: 1px 0px 0px !important; border: 0px !important; height: 1px !important; width: 1px !important; overflow: hidden !important; display: block !important; transition: none 0s ease 0s;"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mover><mi>�</mi><mo stretchy="false">¯</mo></mover></mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mo>=</mo><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">(</mo><mi>�</mi><mo>∗</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>�</mi><mrow class="MJX-TeXAtom-ORD"><mn>2</mn></mrow></msup><msup><mo stretchy="false">)</mo><mrow class="MJX-TeXAtom-ORD"><mn>0.5</mn></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mi>�</mi><mo>+</mo><mi>�</mi><mo>∗</mo><mi>�</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mo>=</mo><msup><mi>�</mi><mn>2</mn></msup><mo>+</mo><msup><mi>�</mi><mn>2</mn></msup><mo>+</mo><mn>2</mn><mi>�</mi><mi>�</mi><mi>�</mi></math></span></span></span></span></p><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">float H = sqrt(Atmosphere.TopRadius * Atmosphere.TopRadius - Atmosphere.BottomRadius * Atmosphere.BottomRadius);</code></pre></div><p data-pid="ds9H9nCY" style="margin: 1.4em 0px;">该H和图中H不是一个点，表示把精度压缩到以（0,0）为原点的H坐标系中</p><p data-pid="jjbSA6Un" style="margin: 1.4em 0px;">IntegrateScatteredLuminance中，主要获取medium.extinction * dt</p><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">viewZenithCosAngle = d == 0.0 ? 1.0f : (H * H - rho * rho - d * d) / (2.0 * viewHeight * d);
...
MediumSampleRGB sampleMediumRGB(in float3 WorldPos, in AtmosphereParameters Atmosphere)
{
	const float viewHeight = length(WorldPos) - Atmosphere.BottomRadius;

	const float densityMie = exp(Atmosphere.MieDensityExpScale * viewHeight);
	const float densityRay = exp(Atmosphere.RayleighDensityExpScale * viewHeight);
	const float densityOzo = saturate(viewHeight &lt; Atmosphere.AbsorptionDensity0LayerWidth ?
		Atmosphere.AbsorptionDensity0LinearTerm * viewHeight + Atmosphere.AbsorptionDensity0ConstantTerm :
		Atmosphere.AbsorptionDensity1LinearTerm * viewHeight + Atmosphere.AbsorptionDensity1ConstantTerm);

	MediumSampleRGB s;

	s.scatteringMie = densityMie * Atmosphere.MieScattering;
	s.absorptionMie = densityMie * Atmosphere.MieAbsorption;
	s.extinctionMie = densityMie * Atmosphere.MieExtinction;

	s.scatteringRay = densityRay * Atmosphere.RayleighScattering;
	s.absorptionRay = 0.0f;
	s.extinctionRay = s.scatteringRay + s.absorptionRay;

	s.scatteringOzo = 0.0;
	s.absorptionOzo = densityOzo * Atmosphere.AbsorptionExtinction;
	s.extinctionOzo = s.scatteringOzo + s.absorptionOzo;

	s.scattering = s.scatteringMie + s.scatteringRay + s.scatteringOzo;
	s.absorption = s.absorptionMie + s.absorptionRay + s.absorptionOzo;
	s.extinction = s.extinctionMie + s.extinctionRay + s.extinctionOzo;
	s.albedo = getAlbedo(s.scattering, s.extinction);

	return s;
}
...
MediumSampleRGB medium = sampleMediumRGB(P, Atmosphere);
const float3 SampleOpticalDepth = medium.extinction * dt;
const float3 SampleTransmittance = exp(-SampleOpticalDepth);
OpticalDepth += SampleOpticalDepth;</code></pre></div><p data-pid="FVHdsHMF" style="margin: 1.4em 0px;">最后得到一张LUT</p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic3.zhimg.com/80/v2-2e7ffefba9a4aee110c2ac0571937bea_720w.webp" data-rawwidth="254" data-rawheight="63" data-size="normal" class="content_image lazy" width="254" data-actualsrc="https://pic3.zhimg.com/v2-2e7ffefba9a4aee110c2ac0571937bea_b.jpg" data-original-token="v2-cc79573046190b294a3d88a685288431" height="63" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div><figcaption style="color: rgb(153, 153, 153); font-size: 0.9em; line-height: 1.5; margin-top: calc(0.666667em); padding: 0px 1em; text-align: center;">长：透射率，宽：高度</figcaption></figure><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;">MultipleScatteringLUT</h3><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">numthreads(1, 1, 64)]
void NewMultiScattCS(uint3 ThreadId : SV_DispatchThreadID)
{
    float2 pixPos = float2(ThreadId.xy) + 0.5f;
    float2 uv = pixPos / MultiScatteringLUTRes;


    uv = float2(fromSubUvsToUnit(uv.x, MultiScatteringLUTRes), fromSubUvsToUnit(uv.y, MultiScatteringLUTRes));

    AtmosphereParameters Atmosphere = GetAtmosphereParameters();

    float cosSunZenithAngle = uv.x * 2.0 - 1.0;
    float3 sunDir = float3(sqrt(saturate(1.0 - cosSunZenithAngle * cosSunZenithAngle)), cosSunZenithAngle, 0.0);
    // We adjust again viewHeight according to PLANET_RADIUS_OFFSET to be in a valid range.
    float viewHeight = Atmosphere.BottomRadius + saturate(uv.y + PLANET_RADIUS_OFFSET) * (Atmosphere.TopRadius -
        Atmosphere.BottomRadius - PLANET_RADIUS_OFFSET);

    float3 WorldPos = float3(0.0f, viewHeight, 0.0f);
    float3 WorldDir = float3(0.0f, 1.0f, 0.0f);


    const bool ground = true;
    const float SampleCountIni = 20; // a minimum set of step is required for accuracy unfortunately
    const float DepthBufferValue = -1.0;
    const bool VariableSampleCount = false;
    const bool MieRayPhase = false;

    const float SphereSolidAngle = 4.0 * PI;
    const float IsotropicPhase = 1.0 / SphereSolidAngle;


    // Reference. Since there are many sample, it requires MULTI_SCATTERING_POWER_SERIE to be true for accuracy and to avoid divergences (see declaration for explanations)
    #define SQRTSAMPLECOUNT 8
    const float sqrtSample = float(SQRTSAMPLECOUNT);
    float i = 0.5f + float(ThreadId.z / SQRTSAMPLECOUNT);
    float j = 0.5f + float(ThreadId.z - float((ThreadId.z / SQRTSAMPLECOUNT) * SQRTSAMPLECOUNT));
    {
        float randA = i / sqrtSample;
        float randB = j / sqrtSample;
        float theta = 2.0f * PI * randA;
        float phi = acos(1.0f - 2.0f * randB);
        // uniform distribution https://mathworld.wolfram.com/SpherePointPicking.html
        //phi = PI * randB;						// bad non uniform
        float cosPhi = cos(phi);
        float sinPhi = sin(phi);
        float cosTheta = cos(theta);
        float sinTheta = sin(theta);
        WorldDir.x = cosTheta * sinPhi;
        WorldDir.y = sinTheta * sinPhi;
        WorldDir.z = cosPhi;
        SingleScatteringResult result = IntegrateScatteredLuminance(uv, WorldPos, WorldDir, sunDir, Atmosphere,
                                                                    ground, SampleCountIni, DepthBufferValue,
                                                                    VariableSampleCount, MieRayPhase);

        MultiScatAs1SharedMem[ThreadId.z] = result.MultiScatAs1 * SphereSolidAngle / (sqrtSample * sqrtSample);
        LSharedMem[ThreadId.z] = result.L * SphereSolidAngle / (sqrtSample * sqrtSample);
    }
    #undef SQRTSAMPLECOUNT

    GroupMemoryBarrierWithGroupSync();

    // 64 to 32
    if (ThreadId.z &lt; 32)
    {
        MultiScatAs1SharedMem[ThreadId.z] += MultiScatAs1SharedMem[ThreadId.z + 32];
        LSharedMem[ThreadId.z] += LSharedMem[ThreadId.z + 32];
    }
    GroupMemoryBarrierWithGroupSync();

    // 32 to 16
    if (ThreadId.z &lt; 16)
    {
        MultiScatAs1SharedMem[ThreadId.z] += MultiScatAs1SharedMem[ThreadId.z + 16];
        LSharedMem[ThreadId.z] += LSharedMem[ThreadId.z + 16];
    }
    GroupMemoryBarrierWithGroupSync();

    // 16 to 8 (16 is thread group min hardware size with intel, no sync required from there)
    if (ThreadId.z &lt; 8)
    {
        MultiScatAs1SharedMem[ThreadId.z] += MultiScatAs1SharedMem[ThreadId.z + 8];
        LSharedMem[ThreadId.z] += LSharedMem[ThreadId.z + 8];
    }
    GroupMemoryBarrierWithGroupSync();
    if (ThreadId.z &lt; 4)
    {
        MultiScatAs1SharedMem[ThreadId.z] += MultiScatAs1SharedMem[ThreadId.z + 4];
        LSharedMem[ThreadId.z] += LSharedMem[ThreadId.z + 4];
    }
    GroupMemoryBarrierWithGroupSync();
    if (ThreadId.z &lt; 2)
    {
        MultiScatAs1SharedMem[ThreadId.z] += MultiScatAs1SharedMem[ThreadId.z + 2];
        LSharedMem[ThreadId.z] += LSharedMem[ThreadId.z + 2];
    }
    GroupMemoryBarrierWithGroupSync();
    if (ThreadId.z &lt; 1)
    {
        MultiScatAs1SharedMem[ThreadId.z] += MultiScatAs1SharedMem[ThreadId.z + 1];
        LSharedMem[ThreadId.z] += LSharedMem[ThreadId.z + 1];
    }
    GroupMemoryBarrierWithGroupSync();
    if (ThreadId.z &gt; 0)
        return;

    float3 MultiScatAs1 = MultiScatAs1SharedMem[0] * IsotropicPhase; // Equation 7 f_ms
    float3 InScatteredLuminance = LSharedMem[0] * IsotropicPhase; // Equation 5 L_2ndOrder

    // MultiScatAs1 represents the amount of luminance scattered as if the integral of scattered luminance over the sphere would be 1.
    //  - 1st order of scattering: one can ray-march a straight path as usual over the sphere. That is InScatteredLuminance.
    //  - 2nd order of scattering: the inscattered luminance is InScatteredLuminance at each of samples of fist order integration. Assuming a uniform phase function that is represented by MultiScatAs1,
    //  - 3nd order of scattering: the inscattered luminance is (InScatteredLuminance * MultiScatAs1 * MultiScatAs1)
    //  - etc.
    #if	MULTI_SCATTERING_POWER_SERIE==0
	float3 MultiScatAs1SQR = MultiScatAs1 * MultiScatAs1;
	float3 L = InScatteredLuminance * (1.0 + MultiScatAs1 + MultiScatAs1SQR + MultiScatAs1 * MultiScatAs1SQR + MultiScatAs1SQR * MultiScatAs1SQR);
    #else
    // For a serie, sum_{n=0}^{n=+inf} = 1 + r + r^2 + r^3 + ... + r^n = 1 / (1.0 - r), see https://en.wikipedia.org/wiki/Geometric_series 
    const float3 r = MultiScatAs1;
    const float3 SumOfAllMultiScatteringEventsContribution = 1.0f / (1.0 - r);
    float3 L = InScatteredLuminance * SumOfAllMultiScatteringEventsContribution; // Equation 10 Psi_ms
    #endif

    OutputTexture[ThreadId.xy] = float4(MultipleScatteringFactor * L, 1.0f);
}</code></pre></div><p data-pid="2aW9OrSu" style="margin: 1.4em 0px;">uv 分别表示<span> </span><b style="font-synthesis: style; font-weight: 600;"><i>高度（r）</i></b>和<b style="font-synthesis: style; font-weight: 600;"><i>太阳</i></b>天顶角（mu_s）</p><p data-pid="kgAj3xVs" style="margin: 1.4em 0px;">根据r算出WorldPos，根据mu_s算出sunDir，均匀采样球面64个点，算球面积分</p><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">        WorldDir.x = cosTheta * sinPhi;
        WorldDir.y = sinTheta * sinPhi;
        WorldDir.z = cosPhi;</code></pre></div><p data-pid="nJXz27Sj" style="margin: 1.4em 0px;">如何球面均匀采样，参考<i><a href="https://link.zhihu.com/?target=https%3A//mathworld.wolfram.com/SpherePointPicking.html" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043" style="color: inherit; text-decoration: none; border-bottom: 1px solid rgb(128, 128, 128); cursor: pointer;"><span class="invisible" style="background-color: transparent; color: transparent; font: 0px / 0 a; text-shadow: none;">https://</span><span class="visible">mathworld.wolfram.com/S</span><span class="invisible" style="background-color: transparent; color: transparent; font: 0px / 0 a; text-shadow: none;">pherePointPicking.html</span><span class="ellipsis"></span></a></i></p><p data-pid="CHEDiFnq" style="margin: 1.4em 0px;">MultipleScattering和Bruneton2017对比，做了优化</p><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">    const float SphereSolidAngle = 4.0 * PI;
    const float IsotropicPhase = 1.0 / SphereSolidAngle;</code></pre></div><p data-pid="yj8t8qvO" style="margin: 1.4em 0px;">1.各项同性</p><p data-pid="jDDDB4qx" style="margin: 1.4em 0px;">2.采样周围点的光能量相同</p><p data-pid="jnW-0jOh" style="margin: 1.4em 0px;">相当于一个系数衰减</p><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">    float3 MultiScatAs1 = MultiScatAs1SharedMem[0] * IsotropicPhase; // Equation 7 f_ms
    float3 InScatteredLuminance = LSharedMem[0] * IsotropicPhase; // Equation 5 L_2ndOrder</code></pre></div><p data-pid="uE8K-bJs" style="margin: 1.4em 0px;">把结果加一起，GroupMemoryBarrierWithGroupSync是做什么的，可以参考</p><div class="RichText-LinkCardContainer"><a target="_blank" href="https://zhuanlan.zhihu.com/p/113532940" data-draft-node="block" data-draft-type="link-card" class="LinkCard new css-1wr1m8" data-za-detail-view-id="172" style="color: inherit !important; text-decoration: none; -webkit-box-align: center; align-items: center; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; background-color: rgb(246, 246, 246); border-radius: 8px; box-sizing: border-box; flex-direction: row; margin: 16px auto; max-width: 100%; min-height: 84px; overflow: hidden; padding: 12px 12px 9px; position: relative; width: 390px; border: none !important;"><span class="LinkCard-contents" style="-webkit-box-flex: 1; display: block; flex: 1 1 auto; position: relative;"><span class="LinkCard-title two-line" style="-webkit-line-clamp: 2; -webkit-box-orient: vertical; color: rgb(18, 18, 18); display: -webkit-box; font-size: 15px; font-weight: 500; line-height: 20px; max-height: 40px; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px;">Compute Shader中的Parallel Reduction和Parallel Scan</span><span class="LinkCard-desc" style="-webkit-line-clamp: 1; -webkit-box-orient: vertical; color: rgb(153, 153, 153); display: -webkit-box; font-size: 13px; height: 18px; line-height: 18px; overflow: hidden; text-overflow: ellipsis; word-break: break-all;">95 赞同 · 4 评论<span class="LinkCard-tag" style="background: rgba(211, 211, 211, 0.3); border-radius: 3px; display: inline-block; font-size: 11px; margin-left: 8px; padding: 0px 4px;">文章</span></span></span><span class="LinkCard-image" style="background-color: rgb(235, 235, 235); border-radius: inherit; display: block; height: 60px; object-fit: cover; width: 60px; -webkit-box-flex: 0; background-position: center center; background-size: cover; flex: 0 0 auto; margin-left: 20px; overflow: hidden; position: relative;"><img src="https://pic1.zhimg.com/v2-bc2cb81e2d6b001f858729e5008c219f_r.jpg?source=172ae18b" alt="" style="height: 60px; object-fit: cover; width: 60px;"></span></a></div><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic4.zhimg.com/80/v2-b1558c4cf1e9eafc64db3e47756b19d7_720w.webp" data-rawwidth="701" data-rawheight="348" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="701" data-original="https://pic4.zhimg.com/v2-b1558c4cf1e9eafc64db3e47756b19d7_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-b1558c4cf1e9eafc64db3e47756b19d7_b.jpg" data-original-token="v2-d489b96c126a5c3f079ccf87a97015dc" height="348" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><p data-pid="Oj_i7BUk" style="margin: 1.4em 0px;">IntegrateScatteredLuminance里面积分运算用了寒霜引擎的方法</p><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">        float3 MS = medium.scattering * 1;
        float3 MSint = (MS - MS * SampleTransmittance) / medium.extinction;
        result.MultiScatAs1 += throughput * MSint;
        ...
        float3 Sint = (S - S * SampleTransmittance) / medium.extinction; // integrate along the current step segment 
        L += throughput * Sint; // accumulate and also take into account the transmittance from previous steps
        throughput *= SampleTransmittance;</code></pre></div><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic2.zhimg.com/80/v2-692c763b45297a8b0b337579946ac3f1_720w.webp" data-rawwidth="720" data-rawheight="403" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="720" data-original="https://pic2.zhimg.com/v2-692c763b45297a8b0b337579946ac3f1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-692c763b45297a8b0b337579946ac3f1_b.jpg" data-original-token="v2-9fe705d024e85d3275374b8661be9b89" height="403" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;">Sky-ViewLUT</h3><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">[numthreads(8, 8, 1)]
void IntergalSkyViewLutPS(uint3 id: SV_DispatchThreadID)
{
    float2 pixPos = id.xy + 0.5f;
    AtmosphereParameters Atmosphere = GetAtmosphereParameters();

    float3 WorldPos = camera + float3(0, Atmosphere.BottomRadius, 0);
    float2 uv = pixPos / float2(192.0, 108.0);
    float viewHeight = length(WorldPos);
    float viewZenithCosAngle;
    float lightViewCosAngle;
    UvToSkyViewLutParams(Atmosphere, viewZenithCosAngle, lightViewCosAngle, viewHeight, uv);


    float3 SunDir;
    {
        float3 UpVector = WorldPos / viewHeight;
        float sunZenithCosAngle = dot(UpVector, sun_direction);
        SunDir = normalize(float3(sqrt(1.0 - sunZenithCosAngle * sunZenithCosAngle), sunZenithCosAngle, 0.0));
    }
    
    
    WorldPos = float3(0.0f, viewHeight, 0.0f);
    
    float viewZenithSinAngle = sqrt(1 - viewZenithCosAngle * viewZenithCosAngle);
    float3 WorldDir = float3(viewZenithSinAngle * lightViewCosAngle,
                             viewZenithCosAngle,
                             viewZenithSinAngle * sqrt(1.0 - lightViewCosAngle * lightViewCosAngle));


    // Move to top atmospehre
    if (!MoveToTopAtmosphere(WorldPos, WorldDir, Atmosphere.TopRadius))
    {
        // Ray is not intersecting the atmosphere
        _SkyViewLUT[id.xy] = float3(0, 0, 0);
        return;
    }

    const bool ground = false;
    const float SampleCountIni = 30;
    const float DepthBufferValue = -1.0;
    const bool VariableSampleCount = true;
    const bool MieRayPhase = true;
    SingleScatteringResult ss = IntegrateScatteredLuminance(uv, WorldPos, WorldDir, SunDir, Atmosphere, ground,
                                                            SampleCountIni, DepthBufferValue, VariableSampleCount,
                                                            MieRayPhase);
     _SkyViewLUT[id.xy] = ss.L;
}</code></pre></div><p data-pid="u7ZOKBlZ" style="margin: 1.4em 0px;">viewZenithCosAngle和lightViewCosAngle取值范围[1,-1]角度0-90度</p><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;"> UvToSkyViewLutParams(Atmosphere, viewZenithCosAngle, lightViewCosAngle, viewHeight, uv);</code></pre></div><p data-pid="Pjz5lNMP" style="margin: 1.4em 0px;">WorldPos UpVector WorldDir 跟UE的区别改了up朝向，UE是z朝上，unity是y朝上</p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic2.zhimg.com/80/v2-d8d45046d8461cdee7892690948e5649_720w.webp" data-rawwidth="679" data-rawheight="378" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="679" data-original="https://pic2.zhimg.com/v2-d8d45046d8461cdee7892690948e5649_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-d8d45046d8461cdee7892690948e5649_b.jpg" data-original-token="v2-99d846b47f7238ae6df0af0a497d542a" height="378" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><h3 style="font-style: inherit; font-variant: inherit; font-weight: 600; font-stretch: inherit; font-size: 1.1em; line-height: 1.5; font-family: inherit; font-optical-sizing: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; margin: calc(1.90909em) 0px calc(1.27273em); clear: left; font-synthesis: style;">AerialPerspectiveLUT</h3><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">[numthreads(8, 8, 1)]
void IntergalCameraVolumeLUT(uint3 id: SV_DispatchThreadID)
{
    float2 pixPos = id.xy + 0.5f;
    float w, h, d;
    _CameraVolumeLUT.GetDimensions(w, h, d);
    AtmosphereParameters Atmosphere = GetAtmosphereParameters();
    float2 uv = pixPos / float2(w, h);
    float3 ClipSpace = float3(uv * float2(2.0, -2.0) - float2(1.0, -1.0), 0.5);
    float4 HViewPos = mul(gSkyInvProjMat, float4(ClipSpace, 1.0));
    float3 WorldDir = normalize(mul((float3x3)gSkyInvViewMat, HViewPos.xyz / HViewPos.w));

    float earthR = Atmosphere.BottomRadius;
    float3 camPos = camera + float3(0, earthR, 0);
    float3 SunDir = sun_direction;
    
    float Slice = ((id.z + 0.5f) / AP_SLICE_COUNT);
    Slice *= Slice; // squared distribution
    Slice *= AP_SLICE_COUNT;

    float3 WorldPos = camPos;

    // Compute position from froxel information
    float tMax = AerialPerspectiveSliceToDepth(Slice);
    float3 newWorldPos = WorldPos + tMax * WorldDir;

    // If the voxel is under the ground, make sure to offset it out on the ground.
    float viewHeight = length(newWorldPos);
    if (viewHeight &lt;= (Atmosphere.BottomRadius + PLANET_RADIUS_OFFSET))
    {
        // Apply a position offset to make sure no artefact are visible close to the earth boundaries for large voxel.
        newWorldPos = normalize(newWorldPos) * (Atmosphere.BottomRadius + PLANET_RADIUS_OFFSET + 0.001f);
        WorldDir = normalize(newWorldPos - camPos);
        tMax = length(newWorldPos - camPos);
    }
    float tMaxMax = tMax;

    const bool ground = false;
    const float SampleCountIni = max(1.0, float(id.z + 1.0) * 2.0f);
    const float DepthBufferValue = -1.0;
    const bool VariableSampleCount = false;
    const bool MieRayPhase = true;
    SingleScatteringResult ss = IntegrateScatteredLuminance(uv, WorldPos, WorldDir, SunDir, Atmosphere, ground,
                                                            SampleCountIni, DepthBufferValue, VariableSampleCount,
                                                            MieRayPhase, tMaxMax);


    const float Transmittance = dot(ss.Transmittance, float3(1.0f / 3.0f, 1.0f / 3.0f, 1.0f / 3.0f));
    _CameraVolumeLUT[id] = float4(ss.L, 1.0 - Transmittance);
}</code></pre></div><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic3.zhimg.com/80/v2-07dea965abb9fdbd93d993621c3a4216_720w.webp" data-rawwidth="504" data-rawheight="190" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="504" data-original="https://pic3.zhimg.com/v2-07dea965abb9fdbd93d993621c3a4216_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-07dea965abb9fdbd93d993621c3a4216_b.jpg" data-original-token="v2-2bc775b842f2970cf79bfafbe32165ef" height="190" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><div class="highlight" style="margin: 1em 0px;"><pre style="margin: 0px; overflow-wrap: initial; background: rgb(246, 246, 246); border-radius: 4px; font-size: 0.9em; overflow: auto; padding: calc(0.888889em); white-space: pre; word-break: initial;"><code class="language-text" style="background-color: inherit; border-radius: 0px; font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-size: inherit; margin: 0px; padding: 0px;">#define AP_SLICE_COUNT 32.0f 切片数
#define AP_KM_PER_SLICE 3.0f  一切片包含多少公里
...
float tMax = AerialPerspectiveSliceToDepth(Slice); 根据切片还原射线最远可到达距离</code></pre></div><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic1.zhimg.com/80/v2-2449c2dd1d58c7802db96d745abe97b8_720w.webp" data-rawwidth="663" data-rawheight="534" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="663" data-original="https://pic1.zhimg.com/v2-2449c2dd1d58c7802db96d745abe97b8_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-2449c2dd1d58c7802db96d745abe97b8_b.jpg" data-original-token="v2-9009a9eca8f18d212d384f39e97bbddc" height="534" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><p data-pid="Bleci94v" style="margin: 1.4em 0px;">号称1ms可以在6s上渲染完成4个lut</p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic1.zhimg.com/80/v2-1403fae03b4a554d86f522539280a3c4_720w.webp" data-rawwidth="1198" data-rawheight="668" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" width="1198" data-original="https://pic1.zhimg.com/v2-1403fae03b4a554d86f522539280a3c4_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-1403fae03b4a554d86f522539280a3c4_b.jpg" data-original-token="v2-b92ab3bbb4400433115c380a20c6c941" height="668" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; cursor: zoom-in; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><p data-pid="Llikcdhq" style="margin: 1.4em 0px;">最后在后处理加上AerialPerspective和shadow的处理即可</p><p data-pid="pIjpiJDE" style="margin: 1.4em 0px;">结尾：</p><p data-pid="QzWw94pu" style="margin: 1.4em 0px;"><a href="https://link.zhihu.com/?target=https%3A//github.com/SlightlyMad/AtmosphericScattering" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043" style="color: inherit; text-decoration: none; border-bottom: 1px solid rgb(128, 128, 128); cursor: pointer;">SlightlyMad</a>，S<a href="https://link.zhihu.com/?target=https%3A//github.com/sebh/UnrealEngineSkyAtmosphere" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043" style="color: inherit; text-decoration: none; border-bottom: 1px solid rgb(128, 128, 128); cursor: pointer;">ebh</a>，B<a href="https://link.zhihu.com/?target=https%3A//github.com/ebruneton/precomputed_atmospheric_scattering" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043" style="color: inherit; text-decoration: none; border-bottom: 1px solid rgb(128, 128, 128); cursor: pointer;">runeton</a><span> </span>的大气散射效果实现各不相同，需要根据实际项目需求修改效果</p><p data-pid="UoLH5bcR" style="margin: 1.4em 0px;">在移动端性能需要做一个取舍，比如原神的天空不是完全基于物理大气渲染，效果也是很棒的</p><p data-pid="c4pW1bIk" style="margin: 1.4em 0px;">本人能力有限，可能有一些错误，请多多指教</p><p data-pid="YKZ16ayW" style="margin: 1.4em 0px;">机翻译了2篇论文，需要自取</p><figure data-size="normal" style="margin: 1.4em 0px;"><div><img src="https://pic1.zhimg.com/80/v2-fde3d90eaf7ab0a7c7a43ac8d3742ca0_720w.webp" data-rawwidth="204" data-rawheight="103" data-size="normal" data-caption="" class="content_image lazy" width="204" data-actualsrc="https://pic1.zhimg.com/v2-fde3d90eaf7ab0a7c7a43ac8d3742ca0_b.jpg" data-original-token="v2-e90ef968a309b4bd86eea39588235c8a" height="103" data-lazy-status="ok" style="display: block; margin: 0px auto; max-width: 100%; height: auto; background-color: transparent; animation: 0.5s ease-in 0s 1 normal none running animation-1yvu044;"></div></figure><p data-pid="G-sGlKNG" style="margin: 1.4em 0px;">项目源码</p><div class="RichText-LinkCardContainer"><a target="_blank" href="https://link.zhihu.com/?target=https%3A//github.com/wujuju/UnitySkyAtmosphere" data-draft-node="block" data-draft-type="link-card" data-text="https://github.com/wujuju/UnitySkyAtmosphere" class="LinkCard new css-1wr1m8" data-za-detail-view-id="172" style="color: inherit !important; text-decoration: none; -webkit-box-align: center; align-items: center; display: flex; -webkit-box-orient: horizontal; -webkit-box-direction: normal; background-color: rgb(246, 246, 246); border-radius: 8px; box-sizing: border-box; flex-direction: row; margin: 16px auto; max-width: 100%; min-height: 84px; overflow: hidden; padding: 12px 12px 9px; position: relative; width: 390px; border: none !important;"><span class="LinkCard-contents" style="-webkit-box-flex: 1; display: block; flex: 1 1 auto; position: relative;"><span class="LinkCard-title two-line" style="-webkit-line-clamp: 2; -webkit-box-orient: vertical; color: rgb(18, 18, 18); display: -webkit-box; font-size: 15px; font-weight: 500; line-height: 20px; max-height: 40px; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px;">https://github.com/wujuju/UnitySkyAtmosphere</span><span class="LinkCard-desc" style="-webkit-line-clamp: 1; -webkit-box-orient: vertical; color: rgb(153, 153, 153); display: -webkit-box; font-size: 13px; height: 18px; line-height: 18px; overflow: hidden; text-overflow: ellipsis; word-break: break-all;"><span style="display: inline-flex; align-items: center;">​<svg width="14" height="14" viewBox="0 0 24 24" class="Zi Zi--InsertLink" fill="currentColor"><path fill-rule="evenodd" d="M5.327 18.883a3.005 3.005 0 0 1 0-4.25l2.608-2.607a.75.75 0 1 0-1.06-1.06l-2.608 2.607a4.505 4.505 0 0 0 6.37 6.37l2.608-2.607a.75.75 0 0 0-1.06-1.06l-2.608 2.607a3.005 3.005 0 0 1-4.25 0Zm5.428-11.799a.75.75 0 0 0 1.06 1.06L14.48 5.48a3.005 3.005 0 0 1 4.25 4.25l-2.665 2.665a.75.75 0 0 0 1.061 1.06l2.665-2.664a4.505 4.505 0 0 0-6.371-6.372l-2.665 2.665Zm5.323 2.117a.75.75 0 1 0-1.06-1.06l-7.072 7.07a.75.75 0 0 0 1.061 1.06l7.071-7.07Z" clip-rule="evenodd"></path></svg></span>github.com/wujuju/UnitySkyAtmosphere</span></span></a></div><p data-pid="XtVUsfUH" style="margin: 1.4em 0px;">参考资料：</p><p data-pid="qzWstohL" style="margin: 1.4em 0px;"><a href="https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/BV1oU4y1R7Km/%3Fspm_id_from%3D333.337.top_right_bar_window_default_collection.content.click%26vd_source%3D701515b74d4706506279918ac2d96c1e" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043" style="color: inherit; text-decoration: none; border-bottom: 1px solid rgb(128, 128, 128); cursor: pointer;">01.游戏引擎导论 | GAMES104-现代游戏引擎：从入门到实践_哔哩哔哩_bilibili</a></p><p data-pid="cRJ8AQSs" style="margin: 1.4em 0px;"><a href="https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/BV1X7411F744/%3Fspm_id_from%3D333.999.0.0%26vd_source%3D701515b74d4706506279918ac2d96c1e" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043" style="color: inherit; text-decoration: none; border-bottom: 1px solid rgb(128, 128, 128); cursor: pointer;">GAMES101-现代计算机图形学入门-闫令琪_哔哩哔哩_bilibili</a></p><p data-pid="EbCalLTU" style="margin: 1.4em 0px;"><a href="https://link.zhihu.com/?target=https%3A//github.com/sebh/UnrealEngineSkyAtmosphere" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043" style="color: inherit; text-decoration: none; border-bottom: 1px solid rgb(128, 128, 128); cursor: pointer;"><span class="invisible" style="background-color: transparent; color: transparent; font: 0px / 0 a; text-shadow: none;">https://</span><span class="visible">github.com/sebh/UnrealE</span><span class="invisible" style="background-color: transparent; color: transparent; font: 0px / 0 a; text-shadow: none;">ngineSkyAtmosphere</span><span class="ellipsis"></span></a></p><p data-pid="ugJetcfu" style="margin: 1.4em 0px;"><a href="https://link.zhihu.com/?target=https%3A//github.com/SlightlyMad/AtmosphericScattering" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043" style="color: inherit; text-decoration: none; border-bottom: 1px solid rgb(128, 128, 128); cursor: pointer;"><span class="invisible" style="background-color: transparent; color: transparent; font: 0px / 0 a; text-shadow: none;">https://</span><span class="visible">github.com/SlightlyMad/</span><span class="invisible" style="background-color: transparent; color: transparent; font: 0px / 0 a; text-shadow: none;">AtmosphericScattering</span><span class="ellipsis"></span></a></p><p data-pid="zidF0H56" style="margin: 1.4em 0px;"><a href="https://link.zhihu.com/?target=https%3A//github.com/ebruneton/precomputed_atmospheric_scattering" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043" style="color: inherit; text-decoration: none; border-bottom: 1px solid rgb(128, 128, 128); cursor: pointer;"><span class="invisible" style="background-color: transparent; color: transparent; font: 0px / 0 a; text-shadow: none;">https://</span><span class="visible">github.com/ebruneton/pr</span><span class="invisible" style="background-color: transparent; color: transparent; font: 0px / 0 a; text-shadow: none;">ecomputed_atmospheric_scattering</span><span class="ellipsis"></span></a></p><p data-pid="lgSP1aUs" style="margin: 1.4em 0px;"><a href="https://link.zhihu.com/?target=https%3A//www.alanzucconi.com/2017/10/10/atmospheric-scattering-1/" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043" style="color: inherit; text-decoration: none; border-bottom: 1px solid rgb(128, 128, 128); cursor: pointer;"><span class="invisible" style="background-color: transparent; color: transparent; font: 0px / 0 a; text-shadow: none;">https://www.</span><span class="visible">alanzucconi.com/2017/10</span><span class="invisible" style="background-color: transparent; color: transparent; font: 0px / 0 a; text-shadow: none;">/10/atmospheric-scattering-1/</span><span class="ellipsis"></span></a></p><p data-pid="ibkgt3Di" style="margin: 1.4em 0px 0px;"><a href="https://link.zhihu.com/?target=https%3A//sebh.github.io/publications/egsr2020.pdf" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043" style="color: inherit; text-decoration: none; border-bottom: 1px solid rgb(128, 128, 128); cursor: pointer;"><span class="invisible" style="background-color: transparent; color: transparent; font: 0px / 0 a; text-shadow: none;">https://</span><span class="visible">sebh.github.io/publicat</span><span class="invisible" style="background-color: transparent; color: transparent; font: 0px / 0 a; text-shadow: none;">ions/egsr2020.pdf</span><span class="ellipsis"></span></a></p></div></div></div></div><div role="button" tabindex="0" class="ContentItem-time" style="color: rgb(133, 144, 166); font-size: 14px; margin: 0px auto; padding: 16px 0px; overflow: hidden; width: 690px; font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">发布于 2023-06-28 19:07・IP 属地广东</div><!--EndFragment-->
</body>
</html>